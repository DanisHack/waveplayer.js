"use strict";var WP={};WP.Mediator=function(){this._topics={};};WP.Mediator.prototype=(function(){return{constructor:WP.Mediator,on:function(topic,callback){if(!this._topics.hasOwnProperty(topic))this._topics[topic]=[];this._topics[topic].push(callback);return true;},un:function(topic,callback){if(!this._topics.hasOwnProperty(topic))return false;if(callback){for(var i=0;i<this._topics[topic].length;i++){if(this._topics[topic][i]===callback){this._topics[topic].splice(i,1);return true;}}}else{delete this._topics[topic];return true;}return false;},unAll:function(){this._topics=null;},fire:function(){var args=Array.prototype.slice.call(arguments),topic=args.shift();if(!this._topics.hasOwnProperty(topic))return false;for(var i=0;i<this._topics[topic].length;i++)this._topics[topic][i].apply(null,args);return true;}};})();WP.UTILS={};WP.UTILS.extend=function(target){var sources=Array.prototype.slice.call(arguments,1);sources.forEach(function(source){if(typeof source!="undefined"){Object.getOwnPropertyNames(source).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}});return target;};WP.UTILS.hex2rgb=function(hex){var bigint=parseInt(hex.charAt(0)=="#"?hex.substring(1,7):hex,16);return{r:(bigint>>16)&255,g:(bigint>>8)&255,b:bigint&255};};WP.UTILS.rgb2hsv=function(rgb){var rr,gg,bb,r=rgb.r/255,g=rgb.g/255,b=rgb.b/255,h,s,v=Math.max(r,g,b),diff=v-Math.min(r,g,b),diffc=function(c){return(v-c)/6/diff+1/2;};if(diff==0)h=s=0;else{s=diff/v;rr=diffc(r);gg=diffc(g);bb=diffc(b);if(r===v)h=bb-gg;else if(g===v)h=1/3+rr-bb;else if(b===v)h=2/3+gg-rr;if(h<0)h+=1;else if(h>1)h-=1;}return{h:Math.round(h*360),s:Math.round(s*100),v:Math.round(v*100)};};WP.UTILS.hsv2rgb=function(hsv){if(hsv.s===0)return{r:hsv.v,g:hsv.v,b:hsv.v};else{var h=hsv.h/60,i=Math.floor(h),s=hsv.s/100,v=hsv.v/100*255,data=[v*(1-s),v*(1-s*(h-i)),v*(1-s*(1-(h-i)))];switch(i){case 0:return{r:v,g:data[2],b:data[0]};case 1:return{r:data[1],g:v,b:data[0]};case 2:return{r:data[0],g:v,b:data[2]};case 3:return{r:data[0],g:data[1],b:v};case 4:return{r:data[2],g:data[0],b:v};default:return{r:v,g:data[0],b:data[1]};}}};WP.UTILS.getJSON=function(url){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.open("GET",url);xhr.onreadystatechange=function(){if(xhr.readyState===XMLHttpRequest.DONE){if(xhr.status===200)resolve(JSON.parse(xhr.responseText));else reject(new Error(xhr.statusText));}};xhr.send();});};WP.UTILS.stateResolver=function(generatorFunction){return function(){var generator=generatorFunction.apply(this,arguments);return new Promise(function(resolve,reject){function resume(method,value){try{var result=generator[method](value);if(result.done)resolve(result.value);else result.value.then(resumeNext,resumeThrow);}catch(e){reject(e);}}var resumeNext=resume.bind(null,"next"),resumeThrow=resume.bind(null,"throw");resumeNext();});}};"use strict";function WaveView(){this.init.apply(this,arguments);}WaveView.prototype=(function(){function _validateParams(){this.container="string"==typeof this._params.container?document.querySelector(this._params.container):this._params.container;if(!this.container)throw new Error("Please supply a valid container element");}function _createWaveContainer(){this.waveContainer=document.createElement("div");this.waveContainer.className="waveform-container";this.container.appendChild(this.waveContainer);this.style(this.waveContainer,{display:"block",height:this._params.height+"px",overflow:"hidden",position:"relative",width:"100%"});_createCanvas.call(this);}function _createCanvas(){var clientWidth=this.waveContainer.clientWidth;var canvas=this.waveContainer.appendChild(this.style(document.createElement("canvas"),{bottom:0,height:this._params.height+"px",position:"absolute",top:0,width:clientWidth+"px",zIndex:1}));this.canvasContext=canvas.getContext("2d");this.canvasContext.canvas.width=clientWidth;this.canvasContext.canvas.height=this._params.height;if(this._params.interact)_addCanvasHandlers.call(this);}function _addCanvasHandlers(){this.__mouseClickHandler=_mouseClickHandler.bind(this);this.canvasContext.canvas.addEventListener("click",this.__mouseClickHandler);}function _removeCanvasHandlers(){this.canvasContect.canvas.removeEventListener("click",this.__mouseClickHandler);}function _mouseClickHandler(e){this._mediator.fire("waveclicked",_coord2Progress.call(this,e));}function _resizeHandler(){if(this._params.responsive){if(this.__resizeHandler)window.removeEventListener("resize",this.__resizeHandler);this.__resizeHandler=(function(e){var width=this.waveContainer.clientWidth;this.style(this.canvasContext.canvas,{width:width+"px"});this.canvasContext.canvas.width=width;this._barData=_calcAvgAmps.call(this);this.updateWave(this._progress);}).bind(this);window.addEventListener("resize",this.__resizeHandler);}else{if(this.__resizeHandler)window.removeEventListener("resize",this.__resizeHandler);}}function _calcMouseCoordX(e){e.preventDefault();return e.clientX-this.waveContainer.getBoundingClientRect().left;}function _coord2Progress(e){return _calcMouseCoordX.call(this,e)/this.waveContainer.clientWidth;}function _calcAvgAmps(){function avgAmp(dataIndex,rangeL,rangeR,n){var sum=0.0;for(var i=rangeL;i<=rangeR;i++)sum+=Math.abs(data[dataIndex+i]);return sum/n;}var totalWidth=this.waveContainer.clientWidth,data=this._params.data,ratio=totalWidth!==data.length?data.length/totalWidth:1,totalBarWidth=this._params.barWidth+this._params.barGap,rangeR=(totalBarWidth-1)/2,rangeL= - ~~rangeR,incr=totalBarWidth*ratio,bd={amps:[],x:[]};rangeR=Math.round(rangeR);this._totalBarWidth=totalBarWidth;bd.amps.push(avgAmp(0,0,rangeR,totalBarWidth));bd.x.push(0);var i,j;for(i=totalBarWidth,j=incr;j+rangeR<data.length;i+=totalBarWidth,j+=incr){bd.amps.push(avgAmp(~~j,rangeL,rangeR,totalBarWidth));bd.x.push(i);}j= ~~j;rangeR= -(j-data.length+1);if(i<=totalWidth-totalBarWidth&&rangeR>rangeL){bd.amps.push(avgAmp(j,rangeL,rangeR,rangeR-rangeL));bd.x.push(i);}bd.norm=1/Math.max.apply(Math,bd.amps);return bd;}function _setupGradient(c,h){var grd=this.canvasContext.createLinearGradient(0,0,0,h),c1="rgba("+ ~~c[1].r+", "+ ~~c[1].g+", "+ ~~c[1].b+", 1)";grd.addColorStop(0.0,c1);grd.addColorStop(0.3,"rgba("+ ~~c[0].r+", "+ ~~c[0].g+", "+ ~~c[0].b+", 1)");grd.addColorStop(1.0,c1);return grd;}function _drawBars(progressCoord){var totalWidth=this.waveContainer.clientWidth,ctx=this.canvasContext,h0=ctx.canvas.height,bd=this._barData,changeGrad=true,bw=this._totalBarWidth,progressColorFlag=true,waveColorFlag=true,gradient=_setupGradient.call(this,this._colors.progressColor,h0);ctx.fillStyle=gradient;for(var i=0;i<bd.x.length;i++){var xpos=bd.x[i];if(xpos>=progressCoord-bw&&changeGrad){if(xpos>=progressCoord){gradient=_setupGradient.call(this,this._colors.waveColor,h0);ctx.fillStyle=gradient;changeGrad=false;}else{var incr=(progressCoord-xpos)/bw,c1={b:this._colors.waveColor[0].b-this._colors.dc.b*incr,g:this._colors.waveColor[0].g-this._colors.dc.g*incr,r:this._colors.waveColor[0].r-this._colors.dc.r*incr},c2=WP.UTILS.rgb2hsv(c1),c2=WP.UTILS.hsv2rgb({h:c2.h,s:c2.s,v:c2.v*1.4});gradient=_setupGradient.call(this,[c1,c2],h0);ctx.fillStyle=gradient;}}var h=Math.max(h0*bd.amps[i]*bd.norm,0.5);ctx.fillRect(xpos,(h0-h)/2,this._params.barWidth,h);}}function _createColorVariations(){var colors={progressColor:[],waveColor:[]};for(var c in colors){var tmp=WP.UTILS.hex2rgb(this._params[c]);colors[c].push(tmp);tmp=WP.UTILS.rgb2hsv(tmp);colors[c].push(WP.UTILS.hsv2rgb({h:tmp.h,s:tmp.s,v:tmp.v*1.4}));}colors.dc={b:(colors.waveColor[0].b-colors.progressColor[0].b),g:(colors.waveColor[0].g-colors.progressColor[0].g),r:(colors.waveColor[0].r-colors.progressColor[0].r)};return colors;}return{constructor:WaveView,init:function(options){this.defaultOptions={barGap:1,barWidth:4,container:null,data:null,height:128,interact:true,progressColor:"#31708f",responsive:true,waveColor:"#428bca"};this._params=WP.UTILS.extend({},this.defaultOptions,options);this._mediator=options.mediator?options.mediator:new Mediator();_validateParams.call(this);_createWaveContainer.call(this);this._colors=_createColorVariations.call(this);_resizeHandler.call(this);},style:function(elm,styles){for(var key in styles){if(elm.style[key]!==styles[key])elm.style[key]=styles[key];}return elm;},data:function(data){if(data)this._params.data=data;else return this._params.data;},drawWave:function(data,progress){this._params.data=data;this._progress=progress;this._barData=_calcAvgAmps.call(this);this.clearWave();_drawBars.call(this,progress*this.waveContainer.clientWidth);},updateWave:function(progress){this._progress=progress;this.clearWave();_drawBars.call(this,progress*this.waveContainer.clientWidth);},clearWave:function(){this.canvasContext.clearRect(0,0,this.canvasContext.canvas.width,this.canvasContext.canvas.height);},interact:function(bool){if(bool===null||bool==="undefined")return this._params.interact;else{this._params.interact=bool;if(bool)_addCanvasHandlers.call(this);else _removeCanvasHandlers.call(this);}},responsive:function(bool){if(bool===null||bool==="undefined")return this._params.responsive;else this._params.responsive=bool;_resizeHandler.call(this);},destroy:function(){_removeCanvasHandlers.call(this);if(this.__resizeHandler)window.removeEventListener("resize",this.__resizeHandler);this._mediator.unAll();this.waveContainer&&this.container.removeChild(this.waveContainer);this.waveContainer=null;}};})();"use strict";function WavePlayer(){this.init.apply(this,arguments);}WavePlayer.prototype=(function(){function _loadAudioElm(url){var me=this;return new Promise(function(resolve,reject){if(me.waveView.container.querySelector("audio"))me.waveView.container.removeChild(me.audioElm);me.audioElm=document.createElement("audio");me.audioElm.controls=false;me.audioElm.autoplay=false;me.audioElm.preload="auto";me.waveView.container.appendChild(me.audioElm);me.audioElm.addEventListener("canplay",function(){me._mediator.fire("canplay");resolve("canplay");});me.audioElm.addEventListener("error",function(e){switch(e.target.error.code){case e.target.error.MEDIA_ERR_ABORTED:reject(new Error("Fetching process aborted by user"));break;case e.target.error.MEDIA_ERR_NETWORK:reject(new Error("There was a problem downloading the audio file"));break;case e.target.error.MEDIA_ERR_DECODE:reject(new Error("There was a problem decoding the audio file"));break;case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:reject(new Error("Audio is not supported, check the provided URL"));break;default:reject("An unknown error occurred");break;}});me.audioElm.addEventListener("timeupdate",function(e){me.waveView.updateWave(_duration2Progress.call(me,e.target.currentTime));});me.audioElm.src=url;me.audioElm.load();});}function _getWaveformData(url){var me=this;return new Promise(function(resolve,reject){WP.UTILS.getJSON(url.substr(0,url.lastIndexOf("."))+".json").then(function(response){if(typeof response==="object")me.waveView.drawWave(response[Object.keys(response)[0]],0);else me.waveView.drawWave(response,0);resolve("jsonfetched");}).catch(function(err){reject(err);});});}function _mediatorHandler(){if(this.__onClickHandler)this._mediator.un("waveclicked",this.__onClickHandler);this.__onClickHandler=(function(progress){if(!this.isPlaying()){this.play();this._mediator.fire("waveclickplay");}else this.skipToSec(progress*this.audioElm.duration);}).bind(this);this._mediator.on("waveclicked",this.__onClickHandler);}function _duration2Progress(time){return time/this.audioElm.duration;}return{constructor:WavePlayer,init:function(options){this.defaultOptions={};this._mediator=new WP.Mediator();this._params=WP.UTILS.extend({},this.defaultOptions,options,{mediator:this._mediator });this.waveView=new WaveView(this._params);},schedulePlaylist:function(options){var me=this;if(this._scheduler)this._scheduler=null;this._scheduler=WP.UTILS.stateResolver(function*(urls){try{for(var i=0;i<urls.length;i++){yield me.load(urls[i]);if(i>0)me.play();else{me._mediator.fire("playlistqueued");if(options.onStart)options.onStart.call(null);}yield me.ended();if(options.onChange)options.onChange.call(null);}return "playlistended";}catch(err){console.error(err);}});this._scheduler(options.urls).then(function(response){me._mediator.fire(response);if(options.onEnd)options.onEnd.call(null,response);},function(err){console.error(err);});},cancelPlaylist:function(){this._scheduler=null;},ended:function(){var me=this;return new Promise(function(resolve){if(me.__ended)me.audioElm.removeEventListener("ended",me.__ended);me.__ended=(function(e){me._mediator.fire("ended");resolve("ended");}).bind(me);me.audioElm.addEventListener("ended",me.__ended);});},load:function(url){var me=this;return Promise.all([Promise.resolve(_loadAudioElm.call(this,url)).then(function(response){_mediatorHandler.call(me);return response;}),_getWaveformData.call(this,url)]);},on:function(topic,fn){this._mediator.on(topic,fn);},un:function(topic,fn){this._mediator.un(topic,fn);},isPlaying:function(){return this.audioElm&& !this.audioElm.paused?true:false;},play:function(){this.audioElm&&this.audioElm.play();},pause:function(){this.audioElm&&this.audioElm.pause();},volume:function(val){if(this.audioElm){if(!val)return this.audioElm.volume;else this.audioElm.volume=val;}},interact:function(bool){return this.waveView.interact(bool);},responsive:function(bool){return this.waveView.responsive(bool);},skipToSec:function(sec){if(this.audioElm)this.audioElm.currentTime=sec;},destroy:function(){this.pause();if(this._scheduler)this._scheduler=null;if(this.audioElm){this.audioElm.removeEventListener("canplay");this.audioElm.removeEventListener("error");this.audioElm.removeEventListener("timeupdate",this.__timeUpdateHandler);if(this.__ended)this.audioElm.removeEventListener("ended",this.__ended);this._mediator.unAll();this.audioElm.parentNode&&this.audioElm.parentNode.removeChild(this.audioElm);this.audioElm=null;}this.waveView.destroy();}};})();
